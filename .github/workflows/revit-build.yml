name: Build Revit 2021 Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # чтобы можно было запустить вручную

jobs:
  build:
    runs-on: windows-latest   # обязательно Windows, потому что Revit API и MSBuild под .NET Framework

    env:
      SOLUTION_FILE: Revit_AutoExternalWall.sln
      PROJECT_FILE: Revit_AutoExternalWall/Revit_AutoExternalWall.csproj       # ← основной проект плагина (опционально)
      CONFIGURATION: Release
      REVIT_VERSION: 2021
      OUTPUT_DIR: Release-2021

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive   

      # Установка Revit 2021 (через chocolatey)
      - name: Install Revit 2021
        run: |
          choco install revit --version=2021.1.9.9 -y --no-progress --force
        # 2021.1.9.9 — последняя версия Revit 2021 на момент 2025 года

      # Добавляем пути к Revit в PATH и создаём переменные окружения
      - name: Add Revit to PATH and set environment variables
        run: |
          echo "C:\Program Files\Autodesk\Revit 2021" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "RevitVersion=2021" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # Восстановление NuGet-пакетов
      - name: Restore NuGet packages
        run: nuget restore ${{ env.SOLUTION_FILE }}

      # Сборка через MSBuild
      - name: Build solution
        run: |
          msbuild ${{ env.SOLUTION_FILE }} `
            /p:Configuration=${{ env.CONFIGURATION }} `
            /p:Platform="Any CPU" `
            /p:TargetFrameworkVersion=v4.7.2 `
            /p:RevitVersion=${{ env.REVIT_VERSION }} `
            /t:Rebuild `
            /v:m `
            /p:OutputPath=bin\${{ env.CONFIGURATION }}\

      # Копируем всё необходимое в папку для артефакта
      - name: Prepare release package
        run: |
          mkdir ${{ env.OUTPUT_DIR }}
          
          # Копируем DLL и addin и всё, что лежит в bin/Release
          Copy-Item -Path "Revit_AutoExternalWall/bin/${{ env.CONFIGURATION }}/*.*" -Destination "${{ env.OUTPUT_DIR }}/" -Recurse
          
          # Копируем .addin файл 
          Copy-Item -Path "Revit_AutoExternalWall/*.addin" -Destination "${{ env.OUTPUT_DIR }}/" -ErrorAction SilentlyContinue
          Copy-Item -Path "*.addin" -Destination "${{ env.OUTPUT_DIR }}/" -ErrorAction SilentlyContinue
          
          # Если у тебя есть Resources, Icons иконки и т.д.
          Copy-Item -Path "Revit_AutoExternalWall/Resources" -Destination "${{ env.OUTPUT_DIR }}/Resources" -Recurse -ErrorAction SilentlyContinue

      # Создаём zip-архив
      - name: Create ZIP artifact
        run: Compress-Archive -Path "${{ env.OUTPUT_DIR }}/*" -DestinationPath "${{ env.OUTPUT_DIR }}.zip"

      # Загружаем артефакт
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Revit2021-Plugin-${{ github.sha }}
          path: ${{ env.OUTPUT_DIR }}.zip

      # Опционально: автоматический релиз при теге (например v1.2.0)
      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.OUTPUT_DIR }}.zip
          generate_release_notes: true
