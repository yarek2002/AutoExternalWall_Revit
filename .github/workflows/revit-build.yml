name: Build Revit 2021 Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      BUILD_PATH: Revit_AutoExternalWall/Revit_AutoExternalWall/Revit_AutoExternalWall.csproj 
      CONFIG: Release
      OUTPUT_DIR: Release-2021

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Скачиваем и кэшируем RevitAPI.dll + RevitAPIUI.dll из твоего релиза
      - name: Cache Revit 2021 API DLLs
        id: cache-revit-api
        uses: actions/cache@v4
        with:
          path: libs/Revit2021
          key: revit2021-api-v3-${{ hashFiles('.github/workflows/build.yml') }}  

      - name: Download Revit 2021 API from GitHub Release
        if: steps.cache-revit-api.outputs.cache-hit != 'true'
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: ${{ github.AutoExternalWall_Revit }}          
          version: tags/revit-api-2021             
          file: Revit2021-API.zip                  
          target: libs/Revit2021.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Revit 2021 API DLLs
        if: steps.cache-revit-api.outputs.cache-hit != 'true'
        run: Expand-Archive -Path libs/Revit2021.zip -DestinationPath libs/Revit2021 -Force

      - name: Check DLL versions
        run: |
          Write-Host "RevitAPI version:"
          (Get-Item "libs/Revit2021/RevitAPI.dll").VersionInfo.FileVersion
          Write-Host "RevitAPIUI version:"
          (Get-Item "libs/Revit2021/RevitAPIUI.dll").VersionInfo.FileVersion

        
# 2. Установка MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Find .csproj automatically
        id: find
        shell: pwsh
        run: |
          $proj = Get-ChildItem -Path . -Filter "*.csproj" -Recurse | Select-Object -First 1
          $normalized = $proj.FullName -replace "\\","/"
          echo "Found project: $normalized"
          echo "csproj_path=$normalized" >> $env:GITHUB_OUTPUT


      - name: NuGet restore
        run: nuget restore "${{ steps.find.outputs.csproj_path }}"

      - name: Show directory structure
        run: tree . /f


      - name: Build
        run: msbuild "${{ steps.find.outputs.csproj_path }}" /p:Configuration=Release /p:Platform=AnyCPU
      


      # 5. Собираем готовый пакет для пользователей
      - name: Prepare release package
        run: |
          New-Item -ItemType Directory -Path ${{ env.OUTPUT_DIR }} -Force

          Copy-Item "Revit_AutoExternalWall/bin/${{ env.CONFIG }}/*" -Destination "${{ env.OUTPUT_DIR }}/" -Recurse

          # Копируем .addin файл(ы) — ищем в корне и в папке проекта
          Copy-Item "*.addin" -Destination "${{ env.OUTPUT_DIR }}/" -ErrorAction SilentlyContinue
          Copy-Item "Revit_AutoExternalWall/*.addin" -Destination "${{ env.OUTPUT_DIR }}/" -ErrorAction SilentlyContinue

          # Если есть папка Resources, Icons и т.п.
          Copy-Item "Revit_AutoExternalWall/Resources" -Destination "${{ env.OUTPUT_DIR }}/Resources" -Recurse -ErrorAction SilentlyContinue

      # 6. Создаём ZIP
      - name: Create ZIP
        run: Compress-Archive -Path "${{ env.OUTPUT_DIR }}/*" -DestinationPath "${{ env.OUTPUT_DIR }}.zip" -Force

      # 7. Загружаем артефакт (всегда видно в Actions)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Revit_AutoExternalWall-2021-${{ github.sha }}.zip
          path: ${{ env.OUTPUT_DIR }}.zip

      # 8. Создаём GitHub Release автоматически при пуше тега (например v1.3.0)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.OUTPUT_DIR }}.zip
          generate_release_notes: true
